[
    {
        "id": "tab_sentinel",
        "type": "tab",
        "label": "Sentinel Core",
        "disabled": true,
        "info": ""
    },
    {
        "id": "feab2e29b155e348",
        "type": "tab",
        "label": "Entrenamiento de Deepstack",
        "disabled": true,
        "info": "",
        "env": []
    },
    {
        "id": "135b5f80cc1e3489",
        "type": "tab",
        "label": "Sistema de Acceso",
        "disabled": false,
        "info": ""
    },
    {
        "id": "broker_mosquitto",
        "type": "mqtt-broker",
        "name": "Local Mosquitto",
        "broker": "mosquitto_broker",
        "port": "1883",
        "clientid": "nodered_core",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "1bab4c633df1172e",
        "type": "ui_base",
        "theme": {
            "name": "theme-light",
            "lightTheme": {
                "default": "#0094CE",
                "baseColor": "#0094CE",
                "baseFont": "Verdana,Verdana,Geneva,sans-serif",
                "edited": false,
                "reset": false
            },
            "darkTheme": {
                "default": "#097479",
                "baseColor": "#097479",
                "baseFont": "Verdana,Verdana,Geneva,sans-serif",
                "edited": true,
                "reset": false
            },
            "customTheme": {
                "name": "Untitled Theme 1",
                "default": "#4B7930",
                "baseColor": "#4B7930",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "reset": false
            },
            "themeState": {
                "base-color": {
                    "default": "#0094CE",
                    "value": "#0094CE",
                    "edited": true
                },
                "page-titlebar-backgroundColor": {
                    "value": "#0094CE",
                    "edited": false
                },
                "page-backgroundColor": {
                    "value": "#fafafa",
                    "edited": false
                },
                "page-sidebar-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-textColor": {
                    "value": "#1bbfff",
                    "edited": false
                },
                "group-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "widget-textColor": {
                    "value": "#111111",
                    "edited": false
                },
                "widget-backgroundColor": {
                    "value": "#0094ce",
                    "edited": false
                },
                "widget-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "base-font": {
                    "value": "Verdana,Verdana,Geneva,sans-serif"
                }
            },
            "angularTheme": {
                "primary": "indigo",
                "accents": "blue",
                "warn": "red",
                "background": "grey",
                "palette": "light"
            }
        },
        "site": {
            "name": "Node-RED Dashboard",
            "hideToolbar": "false",
            "allowSwipe": "false",
            "lockMenu": "false",
            "allowTempTheme": "true",
            "dateFormat": "DD/MM/YYYY",
            "sizes": {
                "sx": 48,
                "sy": 48,
                "gx": 6,
                "gy": 6,
                "cx": 6,
                "cy": 6,
                "px": 0,
                "py": 0
            }
        }
    },
    {
        "id": "256eacd9a6aa3e78",
        "type": "ui_tab",
        "name": "Smart Access System",
        "icon": "dashboard",
        "order": 2
    },
    {
        "id": "mongo_conn_iot",
        "type": "mongodb",
        "hostname": "mongo_iot_db",
        "topology": "direct",
        "connectOptions": "authSource=admin",
        "port": "27017",
        "db": "iot_project",
        "name": "MongoDB Docker"
    },
    {
        "id": "1915cbc1c860ad50",
        "type": "ui_group",
        "name": "Monitoreo en Vivo",
        "tab": "256eacd9a6aa3e78",
        "order": 1,
        "disp": true,
        "width": "10",
        "collapse": false,
        "className": ""
    },
    {
        "id": "1a0ece8aa888b84f",
        "type": "ui_group",
        "name": "Estad√≠sticas",
        "tab": "256eacd9a6aa3e78",
        "order": 2,
        "disp": true,
        "width": "10",
        "collapse": false,
        "className": ""
    },
    {
        "id": "tab_admin",
        "type": "ui_tab",
        "name": "Entrenamiento",
        "icon": "fa-lock",
        "order": 1,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "group_manual_reg",
        "type": "ui_group",
        "name": "Registro Manual (Foto a Foto)",
        "tab": "tab_admin",
        "order": 1,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "98afc57e2ac6d5f6",
        "type": "ui_group",
        "name": "Logs",
        "tab": "256eacd9a6aa3e78",
        "order": 5,
        "disp": true,
        "width": "10",
        "collapse": false,
        "className": ""
    },
    {
        "id": "12a6b9e19c8f1035",
        "type": "ui_group",
        "name": "Monitor en Vivo",
        "tab": "a4e2ec0dd5ae815e",
        "order": 1,
        "disp": true,
        "width": "10",
        "collapse": false,
        "className": ""
    },
    {
        "id": "6f904e0925368796",
        "type": "ui_group",
        "name": "Bit√°cora de Eventos",
        "tab": "a4e2ec0dd5ae815e",
        "order": 3,
        "disp": true,
        "width": 10,
        "collapse": false,
        "className": ""
    },
    {
        "id": "a4e2ec0dd5ae815e",
        "type": "ui_tab",
        "name": "Sistema de Acceso",
        "icon": "dashboard",
        "order": 1,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "4bdd5c8443a2ea18",
        "type": "ui_group",
        "name": "Control de Accesos",
        "tab": "a4e2ec0dd5ae815e",
        "order": 2,
        "disp": true,
        "width": "10",
        "collapse": false,
        "className": ""
    },
    {
        "id": "2e6911f7d55fed26",
        "type": "ui_group",
        "name": "",
        "tab": "a4e2ec0dd5ae815e",
        "order": 5,
        "disp": true,
        "width": 10,
        "collapse": false,
        "className": ""
    },
    {
        "id": "1c76d03ba1249b93",
        "type": "ui_group",
        "name": "Estad√≠sticas",
        "tab": "a4e2ec0dd5ae815e",
        "order": 4,
        "disp": true,
        "width": 10,
        "collapse": false,
        "className": ""
    },
    {
        "id": "1c5decd3881ce31b",
        "type": "mqtt in",
        "z": "tab_sentinel",
        "name": "Entrada: iot/telemetry",
        "topic": "iot/telemetry",
        "qos": "0",
        "datatype": "json",
        "broker": "broker_mosquitto",
        "nl": false,
        "rap": false,
        "inputs": 0,
        "x": 120,
        "y": 60,
        "wires": [
            [
                "ui_template_cam_feed",
                "ae851720952148f8"
            ]
        ]
    },
    {
        "id": "ae851720952148f8",
        "type": "function",
        "z": "tab_sentinel",
        "name": "2. Decodificar Imagen & Prep",
        "func": "// 1. Guardamos datos del contexto (Persistencia)\nflow.set('current_device', msg.payload.device_id);\nflow.set('current_method', msg.payload.access_method);\n\n// 2. Limpieza y Conversi√≥n\n// Aseguramos que sea un string limpio (sin headers data:image...)\nlet base64String = msg.payload.img;\nif (base64String.includes(\",\")) {\n    base64String = base64String.split(\",\")[1];\n}\n\n// Convertimos a Buffer Binario\nconst imgBuffer = Buffer.from(base64String, 'base64');\n\n// 3. CONSTRUCCI√ìN DEL MULTIPART/FORM-DATA (El paso clave)\nconst boundary = \"----WebKitFormBoundary\" + Date.now();\n\n// Cabeceras del \"sobre\"\nmsg.headers = {\n    \"Content-Type\": \"multipart/form-data; boundary=\" + boundary\n};\n\n// Parte 1: Encabezado del archivo dentro del formulario\nconst partHeader = `--${boundary}\\r\\n` +\n                   `Content-Disposition: form-data; name=\"image\"; filename=\"capture.jpg\"\\r\\n` +\n                   `Content-Type: image/jpeg\\r\\n\\r\\n`;\n\n// Parte 2: Pie de p√°gina del formulario\nconst partFooter = `\\r\\n--${boundary}--`;\n\n// 4. Ensamblaje final\n// Unimos: Encabezado + Imagen Binaria + Pie\nmsg.payload = Buffer.concat([\n    Buffer.from(partHeader, 'utf8'),\n    imgBuffer,\n    Buffer.from(partFooter, 'utf8')\n]);\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 120,
        "wires": [
            [
                "d37bbea94c332873"
            ]
        ]
    },
    {
        "id": "ui_template_cam_feed",
        "type": "ui_template",
        "z": "tab_sentinel",
        "group": "1915cbc1c860ad50",
        "name": "Live Camera Feed",
        "order": 2,
        "width": 10,
        "height": 9,
        "format": "<h3>üì∏ √öltimo Intento</h3>\n\n<img\n    src=\"data:image/jpeg;base64,{{msg.payload.img}}\"\n    alt=\"Esperando captura...\"\n    style=\"\n        width: 350px;\n        border-radius: 8px;\n        border: 2px solid #444;\n        box-shadow: 0 4px 6px rgba(0,0,0,0.3);\n        display: block;\n        margin: 0 auto;\n    \"\n/>\n<div style=\"margin-top: 5px; font-size: 12px; color: #888; text-align: center;\">\n    ID Disp: {{msg.payload.device_id}}\n</div>\n",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 410,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "inject_init_history",
        "type": "inject",
        "z": "tab_sentinel",
        "name": "Iniciar/Refrescar",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "0.5",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 140,
        "y": 340,
        "wires": [
            [
                "func_query_last_20"
            ]
        ]
    },
    {
        "id": "func_query_last_20",
        "type": "function",
        "z": "tab_sentinel",
        "name": "Query Last 20",
        "func": "// Configuramos la b√∫squeda para traer los √∫ltimos 20 eventos\nmsg.collection = \"access_logs\";\nmsg.operation = \"find.toArray\";\n// Ordenar descendente (el m√°s nuevo primero)\nmsg.sort = { timestamp: -1 };\nmsg.limit = 20;\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 420,
        "wires": [
            [
                "mongo_find_history"
            ]
        ]
    },
    {
        "id": "mongo_find_history",
        "type": "mongodb in",
        "z": "tab_sentinel",
        "mongodb": "mongo_conn_iot",
        "name": "Get History",
        "collection": "access_logs",
        "operation": "find",
        "x": 470,
        "y": 420,
        "wires": [
            [
                "func_format_replay"
            ]
        ]
    },
    {
        "id": "d37bbea94c332873",
        "type": "http request",
        "z": "tab_sentinel",
        "name": "POST DeepStack",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://deepstack_vision:5000/v1/vision/detection",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 690,
        "y": 120,
        "wires": [
            [
                "3ea843174f2f324c"
            ]
        ]
    },
    {
        "id": "3ea843174f2f324c",
        "type": "function",
        "z": "tab_sentinel",
        "name": "3. L√≥gica 2FA & Prompt",
        "func": "const predictions = msg.payload.predictions || [];\n\n// 1. FILTRO DE SEGURIDAD MEJORADO\n// Subimos la confianza a 0.65 (65%) para ser m√°s estrictos.\n// Verificamos que 'userid' EXISTA y no sea \"unknown\".\nconst recognizedFace = predictions.find(p => \n    p.confidence > 0.65 && \n    p.userid && // Asegura que la propiedad existe\n    p.userid !== \"unknown\"\n);\n\n// Buscamos si hay una cara desconocida (Intruso)\nconst unknownFace = predictions.find(p => \n    p.confidence > 0.65 && \n    p.userid === \"unknown\"\n);\n\n// Recuperar datos previos\nconst method = flow.get('current_method') || 'Desconocido';\n\nlet accessFinal = false;\nlet prompt = \"\";\nlet logStatus = \"\";\n\nif (recognizedFace) {\n    // CASO 1: Persona Autorizada ‚úÖ\n    accessFinal = true;\n    logStatus = \"GRANTED\";\n    const user = recognizedFace.userid; \n    prompt = `Genera un mensaje corto (max 15 palabras) con emojis saludando a ${user} y confirmando su acceso.`;\n\n} else if (unknownFace) {\n    // CASO 2: Persona Desconocida (Intruso) üö®\n    accessFinal = false;\n    logStatus = \"DENIED_UNKNOWN\";\n    prompt = `Genera una alerta de seguridad (max 15 palabras). Rostro desconocido detectado en ${method}. Acceso denegado.`;\n\n} else {\n    // CASO 3: Detecci√≥n Incierta o Vac√≠a ‚ö†Ô∏è\n    // Si la confianza es baja (<0.65) o no hay cara, cae aqu√≠.\n    accessFinal = false;\n    logStatus = \"DENIED_LOW_CONFIDENCE\";\n    prompt = `Genera una advertencia t√©cnica (max 15 palabras). Se intent√≥ acceso por ${method} pero no se identific√≥ un rostro claro.`;\n}\n\n// Guardar estado para el siguiente nodo\nmsg.access_final = accessFinal;\nmsg.log_status = logStatus;\n\n// Payload para OpenAI\nmsg.payload = {\n    \"model\": \"gpt-3.5-turbo\",\n    \"messages\": [\n        { \"role\": \"system\", \"content\": \"Eres un guardia de seguridad digital.\" },\n        { \"role\": \"user\", \"content\": prompt }\n    ],\n    \"temperature\": 0.7\n};\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"Authorization\": \"Bearer \" + \"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\"\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 120,
        "wires": [
            [
                "1e7ab3460e8533b9"
            ]
        ]
    },
    {
        "id": "1e7ab3460e8533b9",
        "type": "http request",
        "z": "tab_sentinel",
        "name": "ChatGPT Gen",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://api.openai.com/v1/chat/completions",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1180,
        "y": 120,
        "wires": [
            [
                "5a76b3a2cae0890f"
            ]
        ]
    },
    {
        "id": "5a76b3a2cae0890f",
        "type": "function",
        "z": "tab_sentinel",
        "name": "4. Salidas y Dashboard",
        "func": "// --- 1. PROCESAR RESPUESTA IA ---\nlet aiText = \"‚ö†Ô∏è Sin respuesta de IA\";\nif (msg.payload && msg.payload.choices && msg.payload.choices.length > 0) {\n    aiText = msg.payload.choices[0].message.content;\n} else if (msg.payload && msg.payload.error) {\n    aiText = \"Error IA: \" + msg.payload.error.message;\n}\n\nconst timestamp = new Date().toLocaleTimeString();\nconst rawStatus = msg.log_status || \"UNKNOWN\";\nconst isGranted = msg.access_final;\n\n// --- 2. TRADUCCI√ìN Y ESTILOS ---\nlet displayStatus = rawStatus;\nlet borderColor = \"#9e9e9e\"; // Gris\nlet bgColor = \"rgba(158, 158, 158, 0.1)\"; \nlet icon = \"‚ö™\";\n\nif (isGranted) {\n    // Caso Verde\n    displayStatus = \"ACCESO PERMITIDO\";\n    borderColor = \"#4CAF50\"; \n    bgColor = \"rgba(76, 175, 80, 0.1)\"; \n    icon = \"‚úÖ\";\n} else {\n    // Casos Rojos (Traducidos)\n    borderColor = \"#F44336\"; \n    bgColor = \"rgba(244, 67, 54, 0.1)\"; \n    icon = \"üö®\";\n    \n    if (rawStatus.includes(\"UNKNOWN\")) displayStatus = \"INTRUSO DESCONOCIDO\";\n    else if (rawStatus.includes(\"NO_FACE\")) displayStatus = \"SIN ROSTRO DETECTADO\";\n    else displayStatus = \"ACCESO DENEGADO\";\n}\n\n// --- 3. NUEVO DISE√ëO HTML ---\nconst logHtml = `\n<div style=\"\n    border-left: 5px solid ${borderColor};\n    background-color: ${bgColor};\n    margin-bottom: 15px;  /* M√°s separaci√≥n entre elementos */\n    padding: 10px 12px;\n    border-radius: 4px;\n    border-bottom: 1px solid #ddd; /* L√≠nea separadora sutil abajo */\n    font-family: 'Segoe UI', sans-serif;\n    box-shadow: 0 2px 5px rgba(0,0,0,0.05);\n\">\n    <div style=\"display:flex; align-items:center; margin-bottom:6px;\">\n        <span style=\"font-family:monospace; color:#555; font-size:12px; margin-right:10px; font-weight:bold;\">\n            [${timestamp}]\n        </span>\n        <span style=\"font-weight:bold; color:${borderColor}; font-size:12px; text-transform:uppercase;\">\n            ${icon} ${displayStatus}\n        </span>\n    </div>\n    <div style=\"font-size:13px; line-height:1.4; color:#333; padding-left:5px;\">\n        ${aiText}\n    </div>\n</div>`;\n\n// --- 4. SALIDAS ---\nconst mqttMsg = {\n    payload: { \"action\": isGranted ? \"OPEN\" : \"CLOSE\", \"reason\": aiText },\n    ai_text_raw: aiText,\n    log_status: rawStatus, // Guardamos el status t√©cnico en BD\n    access_final: isGranted\n};\n\nconst uiTextMsg = { payload: aiText };\nconst uiLogMsg = { payload: logHtml };\n\nconst chartPieMsg = {\n    topic: isGranted ? \"Acceso Permitido\" : \"Acceso Denegado\",\n    payload: 1\n};\n\nconst chartLineMsg = {\n    topic: \"Actividad\",\n    payload: 1,\n    timestamp: new Date().getTime()\n};\n\nreturn [mqttMsg, uiTextMsg, uiLogMsg, chartPieMsg, chartLineMsg];",
        "outputs": 4,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 240,
        "wires": [
            [
                "24f2b2b304e60550",
                "func_prep_mongo_doc"
            ],
            [
                "3bf7e46edc8ec8d4"
            ],
            [
                "f1e948b53f0df415"
            ],
            [
                "c2a2f91c2513f8da"
            ]
        ],
        "outputLabels": [
            "MQTT Command",
            "Dashboard Text",
            "Dashboard Log",
            "Dashboard Chart"
        ]
    },
    {
        "id": "24f2b2b304e60550",
        "type": "mqtt out",
        "z": "tab_sentinel",
        "name": "Salida: iot/commands",
        "topic": "iot/commands",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "broker_mosquitto",
        "x": 1260,
        "y": 200,
        "wires": []
    },
    {
        "id": "3bf7e46edc8ec8d4",
        "type": "ui_text",
        "z": "tab_sentinel",
        "group": "1915cbc1c860ad50",
        "order": 1,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": "",
        "color": "#000000",
        "x": 950,
        "y": 300,
        "wires": []
    },
    {
        "id": "f1e948b53f0df415",
        "type": "ui_template",
        "z": "tab_sentinel",
        "group": "98afc57e2ac6d5f6",
        "name": "Activity Log",
        "order": 1,
        "width": 10,
        "height": "10",
        "format": "<div style=\"height: 100%; overflow-y: auto; padding-right: 5px;\">\n    <div ng-repeat=\"line in logs track by $index\" ng-bind-html=\"line\" class=\"log-entry-anim\">\n    </div>\n</div>\n\n<style>\n    /* Peque√±a animaci√≥n para que se sienta fluido al entrar un log nuevo */\n    .log-entry-anim {\n        animation: fadeIn 0.5s ease-in;\n    }\n\n    @keyframes fadeIn {\n        from {\n            opacity: 0;\n            transform: translateY(-10px);\n        }\n\n        to {\n            opacity: 1;\n            transform: translateY(0);\n        }\n    }\n</style>\n\n<script>\n    (function(scope) {\n        scope.logs = scope.logs || [];\n        scope.$watch('msg', function(msg) {\n            if (msg && msg.payload) {\n                if (Array.isArray(msg.payload)) {\n                    // Carga inicial (Historial)\n                    scope.logs = msg.payload; \n                } else {\n                    // Nuevo evento en vivo\n                    scope.logs.unshift(msg.payload); \n                    // Mantenemos solo los ultimos 50 para no alentar el navegador\n                    if (scope.logs.length > 50) scope.logs.pop();\n                }\n            }\n        });\n    })(scope);\n</script>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 970,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "c2a2f91c2513f8da",
        "type": "ui_chart",
        "z": "tab_sentinel",
        "name": "",
        "group": "1a0ece8aa888b84f",
        "order": 2,
        "width": 0,
        "height": 0,
        "label": "Intentos de Acceso",
        "chartType": "pie",
        "legend": "true",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": "1",
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 990,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "9c9da566b1f79273",
        "type": "change",
        "z": "tab_sentinel",
        "name": "Set Denied",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "Acceso Denegado",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 610,
        "y": 320,
        "wires": [
            [
                "3bf7e46edc8ec8d4"
            ]
        ]
    },
    {
        "id": "func_prep_mongo_doc",
        "type": "function",
        "z": "tab_sentinel",
        "name": "Prep Mongo Document",
        "func": "// Recuperamos datos del contexto\nconst device = flow.get('current_device') || \"unknown\";\nconst method = flow.get('current_method') || \"unknown\";\n\n// msg.payload[0] es el comando MQTT (Open/Close)\n// msg.payload[2] es el Log HTML (Status)\n\n// Creamos un documento limpio para la BD\nmsg.payload = {\n    timestamp: new Date(),\n    device_id: device,\n    access_method: method,\n    status: msg.log_status, // \"GRANTED\" o \"DENIED_VISION\"\n    ai_explanation: msg.ai_text_raw, // Texto puro de ChatGPT\n    chart_value: msg.access_final ? 1 : 0\n};\n\n// Definimos la colecci√≥n\nmsg.collection = \"access_logs\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1010,
        "y": 260,
        "wires": [
            [
                "mongo_save_log"
            ]
        ]
    },
    {
        "id": "mongo_save_log",
        "type": "mongodb out",
        "z": "tab_sentinel",
        "mongodb": "mongo_conn_iot",
        "name": "Save to MongoDB",
        "collection": "access_logs",
        "payonly": true,
        "upsert": false,
        "multi": false,
        "operation": "store",
        "x": 1250,
        "y": 260,
        "wires": []
    },
    {
        "id": "func_format_replay",
        "type": "function",
        "z": "tab_sentinel",
        "name": "Replay History",
        "func": "// 1. PROTECCI√ìN: Verificar si hay datos\nif (!msg.payload || !Array.isArray(msg.payload)) {\n    node.warn(\"MongoDB: No se encontraron logs o formato incorrecto.\");\n    return null;\n}\n\n// Ordenamos cronol√≥gicamente (Viejo -> Nuevo) para procesar\nconst logs = msg.payload.reverse(); \n\nconst logList = [];\nconst pieMsgs = [];\nconst lineMsgs = [];\n\nlogs.forEach(doc => {\n    // --- 2. RECUPERAR DATOS ---\n    const ts = new Date(doc.timestamp);\n    const timeStr = ts.toLocaleTimeString();\n    \n    // Status original y traducci√≥n\n    const rawStatus = doc.status || \"UNKNOWN\";\n    const text = doc.ai_response || \"Sin detalles\";\n    const isGranted = doc.authorized;\n\n    // --- 3. ESTILOS (Id√©ntico al panel en vivo) ---\n    let displayStatus = rawStatus;\n    let borderColor = \"#9e9e9e\";\n    let bgColor = \"rgba(158, 158, 158, 0.1)\"; \n    let icon = \"‚ö™\";\n\n    if (isGranted) {\n        displayStatus = \"ACCESO PERMITIDO\";\n        borderColor = \"#4CAF50\"; // Verde\n        bgColor = \"rgba(76, 175, 80, 0.1)\";\n        icon = \"‚úÖ\";\n    } else {\n        borderColor = \"#F44336\"; // Rojo\n        bgColor = \"rgba(244, 67, 54, 0.1)\";\n        icon = \"üö®\";\n        \n        // Traducci√≥n de errores\n        if (rawStatus.includes(\"UNKNOWN\")) displayStatus = \"INTRUSO DESCONOCIDO\";\n        else if (rawStatus.includes(\"NO_FACE\")) displayStatus = \"SIN ROSTRO DETECTADO\";\n        else displayStatus = \"ACCESO DENEGADO\";\n    }\n    \n    // --- 4. HTML TARJETA ---\n    const html = `\n    <div style=\"\n        border-left: 5px solid ${borderColor};\n        background-color: ${bgColor};\n        margin-bottom: 15px; \n        padding: 10px 12px;\n        border-radius: 4px;\n        border-bottom: 1px solid #ddd;\n        font-family: 'Segoe UI', sans-serif;\n        box-shadow: 0 2px 5px rgba(0,0,0,0.05);\n    \">\n        <div style=\"display:flex; align-items:center; margin-bottom:6px;\">\n            <span style=\"font-family:monospace; color:#555; font-size:12px; margin-right:10px; font-weight:bold;\">\n                [${timeStr}]\n            </span>\n            <span style=\"font-weight:bold; color:${borderColor}; font-size:12px; text-transform:uppercase;\">\n                ${icon} ${displayStatus}\n            </span>\n        </div>\n        <div style=\"font-size:13px; line-height:1.4; color:#333; padding-left:5px;\">\n            ${text}\n        </div>\n    </div>`;\n    \n    // Agregamos al inicio de la lista visual (Nuevo arriba)\n    logList.unshift(html); \n\n    // --- 5. DATOS GR√ÅFICOS ---\n    pieMsgs.push({\n        topic: isGranted ? \"Acceso Permitido\" : \"Acceso Denegado\",\n        payload: 1\n    });\n    lineMsgs.push({\n        topic: \"Actividad\",\n        payload: 1,\n        timestamp: ts.getTime()\n    });\n});\n\n// --- 6. ENVIAR A LAS 5 SALIDAS ---\n// Salida 3: Logs (Array completo)\nnode.send([null, null, { payload: logList }, null, null]);\n\n// Salidas 4 y 5: Gr√°ficas (Punto por punto)\npieMsgs.forEach(m => node.send([null, null, null, m, null]));\nlineMsgs.forEach(m => node.send([null, null, null, null, m]));\n\nreturn null;",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 420,
        "wires": [
            [
                "f1e948b53f0df415"
            ],
            [
                "c2a2f91c2513f8da"
            ]
        ],
        "outputLabels": [
            "To Activity Log",
            "To Chart"
        ]
    },
    {
        "id": "ui_text_manual_id",
        "type": "ui_text_input",
        "z": "feab2e29b155e348",
        "name": "",
        "label": "Nombre de Usuario (ID):",
        "tooltip": "Ej: Admin01",
        "group": "group_manual_reg",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "userid",
        "className": "",
        "topicType": "msg",
        "x": 150,
        "y": 60,
        "wires": [
            [
                "change_manual_id"
            ]
        ]
    },
    {
        "id": "change_manual_id",
        "type": "change",
        "z": "feab2e29b155e348",
        "name": "Guardar ID en Flow",
        "rules": [
            {
                "t": "set",
                "p": "manual_userid",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 400,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "ui_template_manual_cam",
        "type": "ui_template",
        "z": "feab2e29b155e348",
        "group": "group_manual_reg",
        "name": "C√°mara Manual",
        "order": 2,
        "width": 8,
        "height": 10,
        "format": "<div style=\"text-align: center;\">\n    \n    <video id=\"videoManual\" \n           style=\"width: 100%; max-width: 400px; border: 3px solid #444; border-radius: 8px;\" \n           autoplay playsinline></video>\n    <canvas id=\"canvasManual\" style=\"display:none;\"></canvas>\n    \n    \n    <div style=\"margin-top: 15px; display: flex; gap: 10px; justify-content: center;\">\n        <md-button class=\"md-raised\" ng-click=\"initCamera()\" style=\"min-width: 40px;\">\n            <i class=\"fa fa-power-off\"></i> ON\n        </md-button>\n        \n        <md-button class=\"md-raised\" ng-click=\"capturePhoto()\" style=\"flex-grow: 1; font-weight: bold;\">\n            <i class=\"fa fa-camera\"></i> CAPTURAR Y GUARDAR\n        </md-button>\n    </div>\n</div>\n\n<script>\n(function(scope) {\n    var video = document.getElementById('videoManual');\n    var canvas = document.getElementById('canvasManual');\n    var context = canvas.getContext('2d');\n\n    // 1. Encender C√°mara\n    scope.initCamera = function() {\n        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\n            navigator.mediaDevices.getUserMedia({ video: true })\n            .then(function(stream) {\n                video.srcObject = stream;\n                video.play();\n            })\n            .catch(function(err) {\n                alert(\"Error de c√°mara: \" + err);\n            });\n        }\n    };\n\n    // 2. Tomar Foto\n    scope.capturePhoto = function() {\n        if (!video.srcObject) {\n            alert(\"¬°Enciende la c√°mara primero!\");\n            return;\n        }\n        // Dibujar frame en canvas\n        canvas.width = video.videoWidth;\n        canvas.height = video.videoHeight;\n        context.drawImage(video, 0, 0, canvas.width, canvas.height);\n        \n        // Convertir a Base64 y enviar\n        var dataURL = canvas.toDataURL('image/jpeg', 0.95);\n        scope.send({payload: dataURL});\n    };\n})(scope);\n</script>",
        "storeOutMessages": true,
        "fwdInMessages": false,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 130,
        "y": 140,
        "wires": [
            [
                "func_prep_manual_reg"
            ]
        ]
    },
    {
        "id": "func_prep_manual_reg",
        "type": "function",
        "z": "feab2e29b155e348",
        "name": "Prep Multipart",
        "func": "const userid = flow.get('manual_userid');\n\nif (!userid) {\n    node.error(\"Falta el ID\");\n    return [null, {payload: \"‚ö†Ô∏è Escribe un nombre primero\", topic: \"Error\"}]; \n}\n\n// Limpiar Base64\nlet data = msg.payload;\nif(data.includes(',')) data = data.split(',')[1];\nconst imgBuffer = Buffer.from(data, 'base64');\n\nconst boundary = \"----WebKitFormBoundary\" + Date.now();\nmsg.headers = { \"Content-Type\": \"multipart/form-data; boundary=\" + boundary };\n\n// Construir Multipart con 'userid' e 'image'\nconst body = Buffer.concat([\n    Buffer.from(`--${boundary}\\r\\nContent-Disposition: form-data; name=\"userid\"\\r\\n\\r\\n${userid}\\r\\n`, 'utf8'),\n    Buffer.from(`--${boundary}\\r\\nContent-Disposition: form-data; name=\"image\"; filename=\"manual_capture.jpg\"\\r\\nContent-Type: image/jpeg\\r\\n\\r\\n`, 'utf8'),\n    imgBuffer,\n    Buffer.from(`\\r\\n--${boundary}--`, 'utf8')\n]);\n\nmsg.payload = body;\nreturn [msg, null];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 140,
        "wires": [
            [
                "http_post_manual_reg"
            ],
            [
                "ui_toast_manual"
            ]
        ]
    },
    {
        "id": "http_post_manual_reg",
        "type": "http request",
        "z": "feab2e29b155e348",
        "name": "POST Register",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://deepstack_vision:5000/v1/vision/face/register",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 570,
        "y": 140,
        "wires": [
            [
                "func_check_manual_res"
            ]
        ]
    },
    {
        "id": "func_check_manual_res",
        "type": "function",
        "z": "feab2e29b155e348",
        "name": "Check Status",
        "func": "if (msg.payload.success) {\n    msg.payload = \"‚úÖ Foto registrada exitosamente\";\n    msg.topic = \"Success\";\n} else {\n    msg.payload = \"‚ùå Error: \" + (msg.payload.error || \"Desconocido\");\n    msg.topic = \"Error\";\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 140,
        "wires": [
            [
                "ui_toast_manual"
            ]
        ]
    },
    {
        "id": "ui_toast_manual",
        "type": "ui_toast",
        "z": "feab2e29b155e348",
        "position": "top-right",
        "displayTime": "3",
        "highlight": "",
        "outputs": 0,
        "topic": "",
        "name": "",
        "x": 980,
        "y": 140,
        "wires": []
    },
    {
        "id": "9b260215ab88608e",
        "type": "mqtt in",
        "z": "135b5f80cc1e3489",
        "name": "RX: iot/telemetry",
        "topic": "iot/telemetry",
        "qos": "0",
        "datatype": "json",
        "broker": "broker_mosquitto",
        "nl": false,
        "rap": false,
        "inputs": 0,
        "x": 120,
        "y": 80,
        "wires": [
            [
                "7ca6e31123b23f48",
                "7fee0535d5723271"
            ]
        ]
    },
    {
        "id": "7ca6e31123b23f48",
        "type": "ui_template",
        "z": "135b5f80cc1e3489",
        "group": "12a6b9e19c8f1035",
        "name": "Live Feed",
        "order": 1,
        "width": 10,
        "height": 9,
        "format": "<div style=\"text-align: center;\">\n    <img \n        src=\"data:image/jpeg;base64,{{msg.payload.img}}\" \n        width=\"300px\"\n    />\n    <p>\n        ID Disp: {{msg.payload.device_id}} | <b>{{formattedTime}}</b>\n    </p>\n</div>\n\n<script>\n    (function(scope) {\n        scope.$watch('msg', function(msg) {\n            if (msg && msg.payload && msg.payload.timestamp) {\n                try {\n                    var date = new Date(msg.payload.timestamp);\n                    scope.formattedTime = date.toLocaleString('es-MX'); \n                } catch (e) {\n                    scope.formattedTime = msg.payload.timestamp;\n                }\n            } else {\n                scope.formattedTime = \"--/--/---- --:--\";\n            }\n        });\n    })(scope);\n</script>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 320,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "7fee0535d5723271",
        "type": "function",
        "z": "135b5f80cc1e3489",
        "name": "2. Decodificar Imagen",
        "func": "// 1. Guardar contexto\nflow.set('current_device', msg.payload.device_id);\nflow.set('current_method', msg.payload.access_method);\n\n// 2. Limpieza de Base64 (Robusta)\nlet base64String = msg.payload.img;\n\n// Si viene con prefijo data:image..., lo quitamos\nif (base64String.includes(\"base64,\")) {\n    base64String = base64String.split(\"base64,\")[1];\n}\n\nconst imgBuffer = Buffer.from(base64String, 'base64');\n\n// 3. CONSTRUCCI√ìN MULTIPART (Estricta)\nconst boundary = \"--------------------------\" + Date.now().toString(16);\n\nmsg.headers = {\n    \"Content-Type\": \"multipart/form-data; boundary=\" + boundary\n};\n\n// Nota: Los saltos de l√≠nea \\r\\n son CR√çTICOS\nconst partHeader = `--${boundary}\\r\\n` +\n                   `Content-Disposition: form-data; name=\"image\"; filename=\"capture.jpg\"\\r\\n` +\n                   `Content-Type: image/jpeg\\r\\n` +\n                   `\\r\\n`; // L√≠nea vac√≠a antes del contenido binario\n\nconst partFooter = `\\r\\n--${boundary}--`;\n\n// 4. Ensamblaje\nmsg.payload = Buffer.concat([\n    Buffer.from(partHeader, 'utf8'),\n    imgBuffer,\n    Buffer.from(partFooter, 'utf8')\n]);\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 120,
        "wires": [
            [
                "02228c4b8866ae97"
            ]
        ]
    },
    {
        "id": "02228c4b8866ae97",
        "type": "http request",
        "z": "135b5f80cc1e3489",
        "name": "POST Recognize",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://deepstack_vision:5000/v1/vision/face/recognize",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 550,
        "y": 120,
        "wires": [
            [
                "6b3f8a05cef25aaf"
            ]
        ]
    },
    {
        "id": "6b3f8a05cef25aaf",
        "type": "function",
        "z": "135b5f80cc1e3489",
        "name": "3. L√≥gica Seguridad",
        "func": "const predictions = msg.payload.predictions || [];\n\n// CONFIGURACI√ìN DE UMBRALES\nconst THRESHOLD_AUTH = 0.65; // Exigente para abrir la puerta\n\n// 1. BUSCAR AUTORIZADO (Solo entra si la confianza es alta y el nombre existe)\nconst authorizedFace = predictions.find(p => \n    p.confidence > THRESHOLD_AUTH && \n    p.userid && \n    p.userid !== \"unknown\"\n);\n\n// 2. BUSCAR CUALQUIER CARA (INTRUSO)\n// Si el array tiene elementos, ES que hay una cara, aunque la confianza sea 0.\nconst isIntruder = predictions.length > 0 && !authorizedFace;\n\n// --- L√ìGICA DE DECISI√ìN ---\nlet accessFinal = false;\nlet logStatus = \"\";\nlet prompt = \"\";\nlet username = \"Desconocido\";\n\nif (authorizedFace) {\n    // CASO 1: Acceso Permitido ‚úÖ\n    accessFinal = true;\n    logStatus = \"GRANTED\";\n    username = authorizedFace.userid;\n    prompt = `Genera un mensaje muy breve (10 palabras) con emojis alegre confirmando acceso a ${username}.`;\n\n} else if (isIntruder) {\n    // CASO 2: Hay datos en el array, pero no pas√≥ el filtro de autorizado üö®\n    accessFinal = false;\n    logStatus = \"DENIED_UNKNOWN\"; \n    prompt = `Genera una alerta de seguridad seria (10 palabras). Se detect√≥ un rostro no autorizado intentando entrar. Acceso denegado.`;\n\n} else {\n    // CASO 3: El array est√° totalmente vac√≠o (DeepStack no vio nada) ‚ö†Ô∏è\n    accessFinal = false;\n    logStatus = \"DENIED_NO_FACE\";\n    prompt = `Informa brevemente (10 palabras) que la c√°mara no logr√≥ captar ning√∫n rostro humano visible.`;\n}\n\n// --- SALIDAS ---\nmsg.access_final = accessFinal;\nmsg.log_status = logStatus;\nmsg.username = username;\n\n// Payload para ChatGPT\nmsg.payload = {\n    \"model\": \"gpt-3.5-turbo\",\n    \"messages\": [\n        { \"role\": \"system\", \"content\": \"Eres Sentinel, un sistema de seguridad f√≠sica.\" },\n        { \"role\": \"user\", \"content\": prompt }\n    ],\n    \"temperature\": 0.7\n};\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    // Verifica que tu API Key siga aqu√≠\n    \"Authorization\": \"Bearer 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\"\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 120,
        "wires": [
            [
                "0bb8e14188d5add4"
            ]
        ]
    },
    {
        "id": "0bb8e14188d5add4",
        "type": "http request",
        "z": "135b5f80cc1e3489",
        "name": "ChatGPT API",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://api.openai.com/v1/chat/completions",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1000,
        "y": 120,
        "wires": [
            [
                "e59cd87bcb8c1412"
            ]
        ]
    },
    {
        "id": "e59cd87bcb8c1412",
        "type": "function",
        "z": "135b5f80cc1e3489",
        "name": "4. Formatear salida",
        "func": "let aiText = \"‚ö†Ô∏è Sin respuesta de IA\";\nif (msg.payload && msg.payload.choices) {\n    aiText = msg.payload.choices[0].message.content;\n} else if (msg.payload && msg.payload.error) {\n    aiText = \"Error IA: \" + msg.payload.error.message;\n}\n\nconst timestamp = new Date().toLocaleTimeString();\nconst rawStatus = msg.log_status || \"UNKNOWN\";\nconst isGranted = msg.access_final;\nconst user = msg.username || \"-\";\n\n// --- TRADUCCI√ìN LOGS ---\nlet displayStatus = rawStatus;\nif (isGranted) {\n    displayStatus = \"ACCESO PERMITIDO\";\n} else {\n    if (rawStatus.includes(\"UNKNOWN\")) displayStatus = \"DESCONOCIDO\";\n    else if (rawStatus.includes(\"NO_FACE\")) displayStatus = \"SIN ROSTRO DETECTADO\";\n    else displayStatus = \"ACCESO DENEGADO\";\n}\n\n// --- 1. HTML LOG COMPLETO ---\nconst logHtml = `\n<div>\n    [${timestamp}] <b>${displayStatus}:</b> ${aiText}\n</div>\n<hr>`;\n\n// --- 2. HTML ASISTENCIA (SOLO SI ES GRANTED) ---\nlet attendanceHtml = null;\nif (isGranted) {\n    attendanceHtml = `\n    <div>\n        [${timestamp}] <b>${user}</b> ingres√≥ correctamente. ‚úÖ\n    </div>\n    <hr>`;\n}\n\n// --- MENSAJES ---\nconst mqttMsg = {\n    payload: { \"action\": isGranted ? \"OPEN\" : \"CLOSE\", \"reason\": aiText },\n    ai_text_raw: aiText,\n    log_status: rawStatus,\n    access_final: isGranted,\n    username_log: user\n};\n\nconst uiStatusMsg = {\n    payload: `<h2>${displayStatus}</h2><p>${aiText}</p>`\n};\n\nconst uiLogMsg = { payload: logHtml };\nconst uiAttendanceMsg = attendanceHtml ? { payload: attendanceHtml } : null;\n\n// Outputs: [MQTT, UI Status, UI Log, UI Attendance]\nreturn [mqttMsg, uiStatusMsg, uiLogMsg, uiAttendanceMsg];",
        "outputs": 4,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 570,
        "y": 240,
        "wires": [
            [
                "53d51ef693064973",
                "a9cf396188f4e974"
            ],
            [
                "4f6c15971512ee28"
            ],
            [
                "b757f9a5cba5e1f8"
            ],
            [
                "b1956254d1a6390b"
            ]
        ]
    },
    {
        "id": "53d51ef693064973",
        "type": "mqtt out",
        "z": "135b5f80cc1e3489",
        "name": "TX: iot/commands",
        "topic": "iot/commands",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "broker_mosquitto",
        "x": 930,
        "y": 240,
        "wires": []
    },
    {
        "id": "4f6c15971512ee28",
        "type": "ui_template",
        "z": "135b5f80cc1e3489",
        "group": "12a6b9e19c8f1035",
        "name": "Banner Estado",
        "order": 2,
        "width": 10,
        "height": 3,
        "format": "<div ng-bind-html=\"msg.payload\" style=\"text-align:center;\"></div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 920,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "b757f9a5cba5e1f8",
        "type": "ui_template",
        "z": "135b5f80cc1e3489",
        "group": "6f904e0925368796",
        "name": "Lista Logs Simple",
        "order": 1,
        "width": 10,
        "height": 12,
        "format": "<div style=\"height: 100%; overflow-y: auto;\">\n    <div ng-repeat=\"line in logs track by $index\" ng-bind-html=\"line\">\n    </div>\n</div>\n\n<script>\n    (function(scope) {\n        scope.logs = scope.logs || [];\n        scope.$watch('msg', function(msg) {\n            if (msg && msg.payload) {\n                if (Array.isArray(msg.payload)) {\n                    scope.logs = msg.payload; \n                } else {\n                    scope.logs.unshift(msg.payload); \n                    if (scope.logs.length > 50) scope.logs.pop();\n                }\n            }\n        });\n    })(scope);\n</script>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 930,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "a9cf396188f4e974",
        "type": "function",
        "z": "135b5f80cc1e3489",
        "name": "Prep Mongo Save",
        "func": "msg.payload = {\n    timestamp: new Date(),\n    device: flow.get('current_device') || \"unknown\",\n    status: msg.log_status,\n    authorized: msg.access_final,\n    username: msg.username_log || \"Desconocido\", \n    ai_response: msg.ai_text_raw\n};\n\nmsg.collection = \"access_logs\";\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 200,
        "wires": [
            [
                "da4829ceab45f4a0"
            ]
        ]
    },
    {
        "id": "da4829ceab45f4a0",
        "type": "mongodb out",
        "z": "135b5f80cc1e3489",
        "mongodb": "mongo_conn_iot",
        "name": "Save to Logs",
        "collection": "access_logs",
        "payonly": true,
        "upsert": false,
        "multi": false,
        "operation": "store",
        "x": 1110,
        "y": 200,
        "wires": []
    },
    {
        "id": "b1956254d1a6390b",
        "type": "ui_template",
        "z": "135b5f80cc1e3489",
        "group": "4bdd5c8443a2ea18",
        "name": "Lista Asistencias",
        "order": 1,
        "width": 10,
        "height": 12,
        "format": "<div style=\"height: 100%; overflow-y: auto;\">\n    <div ng-repeat=\"line in logs track by $index\" ng-bind-html=\"line\">\n    </div>\n</div>\n\n<script>\n    (function(scope) {\n        scope.logs = scope.logs || [];\n        scope.$watch('msg', function(msg) {\n            if (msg && msg.payload) {\n                if (Array.isArray(msg.payload)) {\n                    scope.logs = msg.payload; \n                } else {\n                    scope.logs.unshift(msg.payload); \n                    if (scope.logs.length > 50) scope.logs.pop();\n                }\n            }\n        });\n    })(scope);\n</script>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 930,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "inject_load_history",
        "type": "inject",
        "z": "135b5f80cc1e3489",
        "name": "Cargar Historial",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": true,
        "onceDelay": "2",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 130,
        "y": 340,
        "wires": [
            [
                "func_query_mongo"
            ]
        ]
    },
    {
        "id": "func_query_mongo",
        "type": "function",
        "z": "135b5f80cc1e3489",
        "name": "Query: √öltimos 100",
        "func": "// Configuramos la consulta\nmsg.collection = \"access_logs\";\nmsg.operation = \"find.toArray\";\n\n// Ordenar por fecha descendente (lo m√°s nuevo primero)\nmsg.sort = { timestamp: -1 };\n\n// L√≠mite de registros para no saturar la pantalla\nmsg.limit = 100;\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 230,
        "y": 420,
        "wires": [
            [
                "mongo_get_logs"
            ]
        ]
    },
    {
        "id": "mongo_get_logs",
        "type": "mongodb in",
        "z": "135b5f80cc1e3489",
        "mongodb": "mongo_conn_iot",
        "name": "Leer MongoDB",
        "collection": "access_logs",
        "operation": "find",
        "x": 420,
        "y": 420,
        "wires": [
            [
                "func_process_history"
            ]
        ]
    },
    {
        "id": "func_process_history",
        "type": "function",
        "z": "135b5f80cc1e3489",
        "name": "Procesar y Separar Listas",
        "func": "// Validaci√≥n de seguridad\nif (!msg.payload || !Array.isArray(msg.payload)) {\n    node.warn(\"MongoDB: No se encontraron datos o hubo un error.\");\n    return null;\n}\n\n// Invertimos el array para procesar del m√°s viejo al m√°s nuevo\n// (As√≠ el unshift los pone en el orden correcto visualmente)\nconst logs = msg.payload.reverse(); \n\nconst logList = [];       // Lista 1: Todo\nconst attendanceList = []; // Lista 2: Solo Accesos\n\nlogs.forEach(doc => {\n    // 1. Extraer datos\n    const ts = new Date(doc.timestamp);\n    const timeStr = ts.toLocaleTimeString();\n    const rawStatus = doc.status || \"UNKNOWN\";\n    const text = doc.ai_response || \"Sin detalles\";\n    const isGranted = doc.authorized;\n    const user = doc.username || \"-\";\n\n    // 2. Determinar Etiqueta para Bit√°cora General\n    let displayStatus = rawStatus;\n    if (isGranted) {\n        displayStatus = \"ACCESO PERMITIDO\";\n    } else {\n        if (rawStatus.includes(\"UNKNOWN\")) displayStatus = \"DESCONOCIDO\";\n        else if (rawStatus.includes(\"NO_FACE\")) displayStatus = \"SIN ROSTRO DETECTADO\";\n        else displayStatus = \"ACCESO DENEGADO\";\n    }\n\n    // 3. HTML BIT√ÅCORA GENERAL\n    const htmlGeneral = `\n    <div>\n        [${timeStr}] <b>${displayStatus}:</b> ${text}\n    </div>\n    <hr>`;\n    logList.unshift(htmlGeneral);\n\n    // 4. HTML LISTA ASISTENCIA (Filtro: Solo si entr√≥)\n    if (isGranted) {\n        const htmlAttend = `\n        <div>\n            [${timeStr}] <b>${user}</b> ingres√≥ correctamente. ‚úÖ\n        </div>\n        <hr>`;\n        attendanceList.unshift(htmlAttend);\n    }\n});\n\n// Salida 1: Bit√°cora Completa\n// Salida 2: Lista de Asistencias\nreturn [{ payload: logList }, { payload: attendanceList }];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 420,
        "wires": [
            [
                "b757f9a5cba5e1f8"
            ],
            [
                "b1956254d1a6390b"
            ]
        ],
        "outputLabels": [
            "A Bit√°cora",
            "A Asistencias"
        ]
    },
    {
        "id": "e04fc7d0e44d8b39",
        "type": "catch",
        "z": "135b5f80cc1e3489",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 740,
        "y": 60,
        "wires": [
            [
                "6b3f8a05cef25aaf"
            ]
        ]
    },
    {
        "id": "inject_load_stats",
        "type": "inject",
        "z": "135b5f80cc1e3489",
        "name": "Actualizar Gr√°ficas",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": true,
        "onceDelay": "2",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 220,
        "y": 580,
        "wires": [
            [
                "func_query_all_stats"
            ]
        ]
    },
    {
        "id": "func_query_all_stats",
        "type": "function",
        "z": "135b5f80cc1e3489",
        "name": "Query: Todo el Historial",
        "func": "msg.collection = \"access_logs\";\nmsg.operation = \"find.toArray\";\n// Traemos suficientes datos para que las estad√≠sticas tengan sentido\nmsg.limit = 500; \nmsg.sort = { timestamp: -1 };\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 580,
        "wires": [
            [
                "mongo_get_stats"
            ]
        ]
    },
    {
        "id": "mongo_get_stats",
        "type": "mongodb in",
        "z": "135b5f80cc1e3489",
        "mongodb": "mongo_conn_iot",
        "name": "Leer MongoDB",
        "collection": "access_logs",
        "operation": "find",
        "x": 680,
        "y": 580,
        "wires": [
            [
                "func_calc_metrics"
            ]
        ]
    },
    {
        "id": "func_calc_metrics",
        "type": "function",
        "z": "135b5f80cc1e3489",
        "name": "Procesar M√©tricas",
        "func": "const logs = msg.payload || [];\n\n// --- 1. DATOS: TASA DE √âXITO (PIE CHART) ---\nlet grantedCount = 0;\nlet deniedCount = 0;\n\n// --- 2. DATOS: TOP USUARIOS (BAR CHART) ---\nconst userCounts = {};\n\n// --- 3. DATOS: ACTIVIDAD (LINE CHART) ---\nconst activityTimeline = {}; \n\nlogs.forEach(doc => {\n    // A. Conteo Global\n    if (doc.authorized) grantedCount++;\n    else deniedCount++;\n\n    // B. Conteo Usuarios\n    const user = doc.username || \"Desconocido\";\n    if (user !== \"Desconocido\" && user !== \"-\") {\n        userCounts[user] = (userCounts[user] || 0) + 1;\n    }\n\n    // C. L√≠nea de Tiempo (Agrupado por hora)\n    // Truco: \"Set minutes to 0\" agrupa todo lo que pas√≥ en la hora 9:00, 9:15, 9:59 en \"9:00\"\n    const timeKey = new Date(doc.timestamp).setMinutes(0, 0, 0); \n    activityTimeline[timeKey] = (activityTimeline[timeKey] || 0) + 1;\n});\n\n// --- GENERAR MENSAJES PARA UI ---\n\n// 1. Mensajes Dona (Se env√≠an como array de objetos)\n// El nodo Chart limpia y redibuja cuando recibe un array nuevo\nconst pieData = [\n    { series: \"Accesos\", data: [[grantedCount]], labels: [\"Permitido\"] },\n    { series: \"Accesos\", data: [[deniedCount]], labels: [\"Denegado\"] }\n];\n// Para Pie Chart de Node-RED Dashboard es mejor enviar puntos sueltos con 'topic'\nconst pieMsgs = [\n    { topic: \"Acceso Permitido\", payload: grantedCount },\n    { topic: \"Acceso Denegado\", payload: deniedCount }\n];\n\n// 2. Mensajes Barras (Top Usuarios)\nconst barMsgs = Object.keys(userCounts).map(user => {\n    return { topic: user, payload: userCounts[user] };\n});\n\n// 3. Mensajes L√≠nea (Actividad)\n// Convertimos timeline a array ordenado por tiempo\nconst lineMsgs = Object.keys(activityTimeline).sort().map(ts => {\n    return {\n        topic: \"Actividad\",\n        payload: activityTimeline[ts],\n        timestamp: parseInt(ts)\n    };\n});\n\n// --- ENVIAR SALIDAS (3 Cables) ---\n\n// Salida 1: Dona\nnode.send([pieMsgs, null, null]);\n\n// Salida 2: Barras\nnode.send([null, barMsgs, null]);\n\n// Salida 3: L√≠nea\nnode.send([null, null, lineMsgs]);\n\nreturn null;",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 580,
        "wires": [
            [
                "chart_pie_stats"
            ],
            [
                "chart_bar_users"
            ],
            [
                "chart_line_timeline"
            ]
        ],
        "outputLabels": [
            "Pie Chart",
            "Bar Chart",
            "Line Chart"
        ]
    },
    {
        "id": "chart_pie_stats",
        "type": "ui_chart",
        "z": "135b5f80cc1e3489",
        "name": "Tasa de √âxito",
        "group": "2e6911f7d55fed26",
        "order": 1,
        "width": 0,
        "height": 0,
        "label": "Seguridad Global",
        "chartType": "pie",
        "legend": "true",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": "1",
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#4caf50",
            "#f44336",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 1120,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "chart_bar_users",
        "type": "ui_chart",
        "z": "135b5f80cc1e3489",
        "name": "Top Usuarios",
        "group": "1c76d03ba1249b93",
        "order": 1,
        "width": 10,
        "height": 6,
        "label": "Accesos por Usuario",
        "chartType": "bar",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "0",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": true,
        "useUTC": false,
        "colors": [
            "#2196f3",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 1110,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "chart_line_timeline",
        "type": "ui_chart",
        "z": "135b5f80cc1e3489",
        "name": "L√≠nea de Tiempo",
        "group": "1c76d03ba1249b93",
        "order": 2,
        "width": 10,
        "height": 6,
        "label": "Tendencia de Actividad",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "0",
        "ymax": "",
        "removeOlder": "1",
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#ffc107",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 1130,
        "y": 600,
        "wires": [
            []
        ]
    }
]